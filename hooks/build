#!/bin/bash
set -e

PUSH=""

docker build -t solsson/kafka -t "$IMAGE_NAME" ./kafka
PUSH="$PUSH $IMAGE_NAME"

nonroot=$(echo -n $IMAGE_NAME | sed "s|:|:nonroot-|")
docker build -t solsson/kafka:nonroot -t "$nonroot" ./kafka-nonroot
PUSH="$PUSH $nonroot"

# Generatoe entrypoints
entrypoints=$(echo -n $IMAGE_NAME | sed "s|:|:entrypoints-|")
docker build -t $entrypoints ./kafka-entrypoints

function entrypoint_gen {
  echo "# $@"
  script=$1; shift
  name=$(basename $script | sed 's|\.sh$||')
  dfile=./kafka-entrypoints/$name.Dockerfile
  image=$(echo -n $IMAGE_NAME | sed "s|:|:$name-|")
  echo "FROM solsson/kafka:nonroot" > $dfile
  # TODO ideally we'd have only [executable, -cp, long classpath string] in entrypoint and the rest as CMD
  echo -n 'ENTRYPOINT ["'  >> $dfile
  docker run --rm --entrypoint $script $entrypoints $@ \
    | sed 's| |", \\\
  "|g'     >> $dfile
  echo '"]'                >> $dfile
  docker build -t $image -f $dfile ./kafka-entrypoints
  PUSH="$PUSH $image"
}

entrypoint_gen ./bin/kafka-server-start.sh ./config/server.properties
entrypoint_gen ./bin/zookeeper-server-start.sh ./cofig/zookeeper.properties
entrypoint_gen ./bin/kafka-configs.sh
entrypoint_gen ./bin/kafka-topics.sh
entrypoint_gen ./bin/kafka-consumer-groups.sh
entrypoint_gen ./bin/kafka-reassign-partitions.sh
entrypoint_gen ./bin/kafka-leader-election.sh

# Entrypoints done

[ -z "$NOPUSH" ] || exit 0
for P in $PUSH; do docker push $P; done
